
on:
  issues:
    types:
      - assigned

permissions:
  issues: write

jobs:
  add-assignment-timestamp:
    runs-on: ubuntu-latest
    if: github.event.issue.pull_request == null
    steps:
      - name: Add timestamp and deadline comment
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const issue_number = issue.number;
            const { owner, repo } = context.repo;
            const assignee = context.payload.assignee.login;

            // Get all comments
            const comments = await github.rest.issues.listComments({
              owner,
              repo,
              issue_number,
              per_page: 100
            });

            // Prevent duplicate comments for same assignee
            const alreadyCommented = comments.data.find(c =>
              c.body && c.body.includes('<!-- assigned-timestamp:' + assignee + ' -->')
            );
            if (alreadyCommented) return;

            // Get issue body
            const body = issue.body || "";
            let days = 6; // fallback default

            // Extract line after "### Priority"
            const priorityMatch = body.match(/### Priority\s*\n([^\n]+)/i);
            if (priorityMatch) {
              const line = priorityMatch[1].trim();
              const dayMatch = line.match(/(\d+)\s*days?/i);
              if (dayMatch) {
                days = parseInt(dayMatch[1], 10);
              }
            }

            const assignedDate = new Date();
            const deadlineDate = new Date(assignedDate);
            deadlineDate.setDate(assignedDate.getDate() + days);

            const format = d => d.toISOString().split("T")[0];

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number,
              body: `<!-- assigned-timestamp:${assignee} -->\n` +
                    `ğŸ‘¤ **@${assignee}** assigned on **${format(assignedDate)}**\n` +
                    `â³ Deadline (based on priority): **${format(deadlineDate)}**`
            });
